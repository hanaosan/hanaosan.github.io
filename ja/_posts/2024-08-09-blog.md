---
title: "ã€GitHub Actionsã€‘è‡ªä½œPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã—ã¦PyPIã¨GitHubãƒªãƒªãƒ¼ã‚¹ã¾ã§ä¸€æ°—ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ğŸğŸ“¦"
date: 2024-08-09
excerpt: "ã€GitHub Actionsã€‘è‡ªä½œPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è‡ªå‹•ãƒ“ãƒ«ãƒ‰ã—ã¦PyPIã¨GitHubãƒªãƒªãƒ¼ã‚¹ã¾ã§ä¸€æ°—ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ğŸğŸ“¦"
lang: ja
ref: 2024-08-09
---
![teaser](/assets/img/blog01.png){:width="450px"}

è‡ªä½œã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã¨ãã«ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ã€TestPyPIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèªã—ã¦ã€PyPIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€æœ€å¾Œã«ã‚¿ã‚°åˆ‡ã£ã¦ãƒªãƒªãƒ¼ã‚¹ã—ã¦ãƒ»ãƒ»ãƒ»
é¢å€’ãªã®ã§GitHub Actionsã§ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## ã“ã®è¨˜äº‹ã§ç›®æŒ‡ã™ã“ã¨

ãƒªãƒ¢ãƒ¼ãƒˆã«ã‚¿ã‚°ã‚’pushã—ãŸéš›ã«ã€è‡ªå‹•ã§PyPIã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€GitHubã«ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰tagã‚’pushã™ã‚‹ã¨ã€ã€ã€
```
git tag vX.X.X
git push origin vX.X.X
```

ä»¥ä¸‹é †ç•ªã§è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
1. testPyPIã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. PyPIã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
3. GitHubä¸Šã«ãƒªãƒªãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é…å¸ƒ

ä¸‹è¨˜ç”»åƒã®ã‚ˆã†ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

![Screenshot 2024-08-09 at 17.18.42.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1622041/55ba543a-d487-7349-eebe-e3d13a783f54.png)

## æ‰‹é †

### æº–å‚™

**æ³¨æ„:
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ setup.py ã§ã¯ãªãã€pyproject.toml ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚[PEP-518](https://peps.python.org/pep-0518/)ã«ã‚ˆã‚Šã€ãƒ¢ãƒ€ãƒ³ãªPythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯pyproject.tomlã®ä½¿ç”¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚**

Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨æ„ã—ã¦PyPIã¨TestPyPIã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
ã™ã§ã«è‡ªä½œã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒPyPIä¸Šã«ã‚ã‚‹å ´åˆã¯é£›ã°ã—ã¦ãã ã•ã„ã€‚

ä¸‹è¨˜ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«å¾“ã£ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’TestPyPIã¨PyPIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
[https://packaging.python.org/ja/latest/tutorials/packaging-projects/#creating-a-license](https://packaging.python.org/ja/latest/tutorials/packaging-projects/#creating-a-license)

### GitHub Actionsã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
ãƒªãƒã‚¸ãƒˆãƒª> Actions> set up a workflow yourself> ä»»æ„ã®åå‰ã§yamlãƒ•ã‚¡ã‚¤ãƒ«(ä»Šå›ã¯main.yaml)ã‚’ä½œæˆã—commitã€‚ç©ºãƒ•ã‚¡ã‚¤ãƒ«ã§OKã§ã™ã€‚

### PyPIã§Publishingã®è¨­å®š
å¾“æ¥ã€GitHub Actionsã‹ã‚‰PyPIã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã™ã‚‹ãŸã‚ã«ã¯PyPIã§APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã—ã€GitHubå´ã§ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Secretã¨ã—ã¦ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

ã—ã‹ã—Publishingã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€äº‹å‰ã«è¨­å®šã—ã¦ã‚ã‚‹ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹(ãŠã‚ˆã³ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãƒªãƒã‚¸ãƒˆãƒªãªã©)ã¨ã®æ¥ç¶šã®éš›ã«ã€ä¸€æ™‚çš„ãªãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã€èªè¨¼ã¾ã§ã‚’è‡ªå‹•ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ï¼

è¨­å®šã®ç°¡å˜ã§ã™ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒçŸ­ã„ã®ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«ã‚‚Publishingã‚’ä½¿ç”¨ã™ã‚‹æ–¹ãŒè‰¯ã•ãã†ã§ã™ã€‚

PyPIã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã‹ã‚‰Publishing> Add a new publisherã‚’é¸æŠã—ã¾ã™ã€‚

`https://pypi.org/manage/project/[ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå]/settings/publishing/`

ä»¥ä¸‹ç”»åƒã®ã‚ˆã†ã«è¨˜å…¥ã—ã€Addã—ã¾ã™ã€‚

![Screenshot 2024-08-09 at 17.54.30.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1622041/0ec3d2b6-af81-cc74-7e42-8cde967521f3.png)

TestPyPIã‚’é–‹ãã€åŒã˜ã‚ˆã†ã«Publisherã‚’ä½œæˆã—ã¾ã™ã€‚
Environment nameã¯PyPIã¨ã¯åˆ¥ã®ã‚‚ã®ã«ã—ã¾ã™ã€‚

![Screenshot 2024-08-09 at 18.00.54.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1622041/aa62bdd2-57a2-9dd3-35c9-30bdef24ce63.png)

### GitHub Actionsã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¨­å®š
å…ˆã»ã©ä½œæˆã—ãŸyamlã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

#### 1. ã‚¿ã‚°ãŒpushã•ã‚ŒãŸã¨ãã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã™ã‚‹

```yaml
name: Publish Python ğŸ distribution ğŸ“¦ to PyPI and TestPyPI

on:
  push:
    tags:
      - 'v*.*.*'
```

#### 2. ãƒ“ãƒ«ãƒ‰
ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã«ã¯pyproject.tomlãŒãƒªãƒã‚¸ãƒˆãƒªä¸Šã«å­˜åœ¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã®ã§.gitignoreã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚

```yaml
jobs:
  build:
    name: Build distribution ğŸ“¦
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4 # ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
    - name: Set up Python
      uses: actions/setup-python@v5 # Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      with:
        python-version: "3.x"
    - name: Install pypa/build # ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: >-
        python3 -m
        pip install
        build
        --user
    - name: Build a binary wheel and a source tarball
      run: python3 -m build # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
    - name: Store the distribution packages # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’python-package-distributionsã¨ã„ã†åå‰ã§distãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¸€æ™‚çš„ã«ä¿å­˜
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
```

#### 3. TestPyPIã¸ã®å…¬é–‹

```yaml
  publish-to-testpypi:
    name: Publish Python ğŸ distribution ğŸ“¦ to TestPyPI
    needs:
    - build # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ãŒå®Œäº†ã—ãŸå ´åˆã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã™ã‚‹
    runs-on: ubuntu-latest

    environment:
      name: testpypi # Publisherã«è¨­å®šã—ãŸenvironment nameã‚’å…¥åŠ›
      url: https://test.pypi.org/p/example-package-hanaosan0318 # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL

    permissions:
      id-token: write  # Publishingã®æ¨©é™ã‚’ä»˜ä¸

    steps:
    - name: Download all the dists # å…ˆã»ã©ä¿å­˜ã—ãŸãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    - name: Publish distribution ğŸ“¦ to TestPyPI # TestPyPIã¸å…¬é–‹
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
```

#### 4. PyPIã¸ã®å…¬é–‹

```yaml
  publish-to-pypi:
    name: >-
      Publish Python ğŸ distribution ğŸ“¦ to PyPI
    needs:
    - publish-to-testpypi # TestPyPIã¸ã®å…¬é–‹ãŒå®Œäº†ã—ãŸå ´åˆã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã™ã‚‹
    runs-on: ubuntu-latest
    environment:
      name: pypi # Publisherã«è¨­å®šã—ãŸenvironment nameã‚’å…¥åŠ›
      url: https://pypi.org/p/example-package-hanaosan0318 # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆURL
    permissions:
      id-token: write

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
    - name: Publish distribution ğŸ“¦ to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
```

#### 5. ãƒªãƒªãƒ¼ã‚¹ã®ä½œæˆ

```yaml
  github-release:
    name: >-
      Create GitHub Release with source code
    needs:
    - publish-to-pypi # PyPIã¸ã®å…¬é–‹ãŒå®Œäº†ã—ãŸå ´åˆã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹
    runs-on: ubuntu-latest
  
    permissions:
      contents: write # GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ãŸã‚ã®æ¨©é™
  
    steps:
    - name: Checkout code
      uses: actions/checkout@v4 # ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
  
    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ä¸€æ™‚çš„ãªãƒˆãƒ¼ã‚¯ãƒ³
      run: >-
        gh release create
        '${{ github.ref_name }}'
        --repo '${{ github.repository }}'
        --notes "Release for version ${{ github.ref_name }}"
```

ã“ã‚Œã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸï¼

yamlãƒ•ã‚¡ã‚¤ãƒ«ã®å…¨ä½“ã¯ä»¥ä¸‹ãƒªãƒ³ã‚¯ã‹ã‚‰è¦‹ã‚‰ã‚Œã¾ã™ã€‚

[https://github.com/hanaosan/ci-cd-practice-python-library/blob/main/.github/workflows/main.yml](https://github.com/hanaosan/ci-cd-practice-python-library/blob/main/.github/workflows/main.yml)

## ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã‚‹

pyproject.tomlã®versionã‚’ä»Šå›ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¿®æ­£ã—ã¦pushã—ã¦ãŠãã¾ã™ã€‚

```
[project]
name = "example_package_hanaosan0318"
version = "2.0.3" # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´
authors = [
  { name="Example Author", email="author@example.com" },
]
```

ã‚¿ã‚°ã‚’ä½œæˆã—pushã—ã¾ã™ã€‚
```
git tag v2.0.3
git push origin v2.0.3
```

PyPIã¨TestPyPIã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

![Screenshot 2024-08-09 at 18.43.32.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1622041/a6319019-361d-45be-fcb1-0a42b1c1e71e.png)

ã¾ãŸãƒªãƒªãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒzipã¨tar.gzã§é…å¸ƒã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚

![Screenshot 2024-08-09 at 18.44.15.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/1622041/60c9245d-ddab-bb46-ae3b-53a790d6320e.png)


ã“ã‚Œã§ãƒªãƒ¢ãƒ¼ãƒˆã«ã‚¿ã‚°ã‚’pushã—ãŸéš›ã«ã€è‡ªå‹•ã§PyPIã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€GitHubã«ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚


### å‚è€ƒ

- ä»Šå›ä½¿ã£ãŸãƒªãƒã‚¸ãƒˆãƒª: [https://github.com/hanaosan/ci-cd-practice-python-library](https://github.com/hanaosan/ci-cd-practice-python-library)
- [GitHub Actions CI/CD ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç”¨ã„ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é…å¸ƒç‰©ã®ãƒªãƒªãƒ¼ã‚¹ã‚’å…¬é–‹ã™ã‚‹](https://packaging.python.org/ja/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/#workflow-definition)
